"use strict";define(["jquery","TYPO3/CMS/Sessionplaner/DragDrop","TYPO3/CMS/Backend/Modal","TYPO3/CMS/Backend/Severity"],function(o,s,n,i){function t(){this.pageId=0,this.uiBlock=null,this.stash=null,this.gridButtonGroup=null,this.gridNewSessionButton=null,this.sessionData={},this.ajaxActive=!1,this.dragActive=!1,this.initialize()}return t.prototype.setPageId=function(t){this.pageId=t},t.prototype.getTemplateElement=function(t){return o(o("#"+t).html().replace(/^\s+|\s+$/g,""))},t.prototype.prepareData=function(t){var s={};return o.each(t,function(t,e){"attendees"!==e.name&&"type"!==e.name&&"level"!==e.name&&"day"!==e.name&&"room"!==e.name&&"slot"!==e.name||(e.value=parseInt(e.value)||0),s[e.name]=e.value}),s},t.prototype.applySessionValuesToForm=function(n,t){return o.each(t,function(t,e){var s=o("input."+t+":first",n);0<s.length&&s.val(e)}),n},t.prototype.applySessionValuesToCard=function(t,e){var s=t.find(".t3-page-ce-body-inner");return o.each(e,function(t,e){o("."+t,s).data("value",e).text(e)}),t},t.prototype.addValuesFromParent=function(t,e){return"stash"===e.attr("id")?(t.slot=0,t.room=0):(t.slot=e.data("slot"),t.room=e.data("room")),t},t.prototype.createSessionCard=function(t){var e=this.getTemplateElement("sessionCardTemplate");return this.applySessionValuesToCard(e,t)},t.prototype.updateSessionCard=function(t){var e=o('.uid[data-value="'+t.uid+'"]',".t3js-page-ce").parents(".t3js-page-ce");this.applySessionValuesToCard(e,t)},t.prototype.getDataFromCard=function(t){var e=o(t).find(".t3-page-ce-body-inner"),s={};return e.find(".property").each(function(){var t=o(this);s[t.data("name")]=t.data("value")}),s},t.prototype.createSessionSuccess=function(t){this.sessionData.uid=t.data.uid;var e=this.createSessionCard(this.sessionData);this.sessionData.room&&this.sessionData.slot?o('[data-room="'+this.sessionData.room+'"][data-slot="'+this.sessionData.slot+'"]').prepend(e):this.stash.prepend(e),s.initializeDraggable(e)},t.prototype.updateSessionSuccess=function(){this.updateSessionCard(this.sessionData)},t.prototype.movedSessionSuccess=function(){},t.prototype.deleteSessionSuccess=function(){var e=this;o('[data-name="uid"]').each(function(){var t=o(this);parseInt(t.data("value"))===e.sessionData.uid&&t.parents(".t3-page-ce").remove()})},t.prototype.beforeSend=function(){var t=!0;return this.ajaxActive?t=!1:(this.ajaxActive=!0,this.uiBlock.removeClass("hidden")),t},t.prototype.afterSend=function(){this.uiBlock.addClass("hidden"),this.ajaxActive=!1},t.prototype.sendAjaxRequest=function(t,e,s){var n=this;o.ajax(TYPO3.settings.ajaxUrls[t],{method:"post",beforeSend:function(){n.beforeSend()},complete:function(){n.afterSend()},data:{id:n.pageId,tx_sessionplaner:{session:e}}}).done(s)},t.prototype.createSession=function(t){var e=this;this.sessionData=this.prepareData(o("form",t.target).serializeArray()),this.sendAjaxRequest("evoweb_sessionplaner_create",this.sessionData,function(t){e.createSessionSuccess(t)})},t.prototype.updateSession=function(t){var e=this,s=this.prepareData(o("form",t.target).serializeArray());s.uid=this.sessionData.uid,this.sessionData=s,this.sendAjaxRequest("evoweb_sessionplaner_update",this.sessionData,function(t){e.updateSessionSuccess(t)})},t.prototype.deleteSession=function(t){var e=this;this.sessionData={uid:o(t).parents(".t3-page-ce").find(".uid").data("value")},this.sendAjaxRequest("evoweb_sessionplaner_delete",this.sessionData,function(t){e.deleteSessionSuccess(t)})},t.prototype.movedSession=function(t,e){var s=this,n=this.getDataFromCard(t);this.sessionData=this.addValuesFromParent(n,e),this.sendAjaxRequest("evoweb_sessionplaner_update",this.sessionData,function(t){s.movedSessionSuccess(t)})},t.prototype.createNewSessionForm=function(){var e=this;this.sessionData={},n.confirm("Create session",this.applySessionValuesToForm(this.getTemplateElement("sessionFormTemplate"),this.sessionData),i.ok,[{text:"Create session",active:!0,btnClass:"btn-default",name:"ok"},{text:"Cancel",active:!0,btnClass:"btn-default",name:"cancel"}]).on("button.clicked",function(){n.dismiss()}).on("confirm.button.ok",function(t){e.createSession(t)})},t.prototype.createNewSessionFormInGrid=function(){var e=this;n.confirm("Create session",this.applySessionValuesToForm(this.getTemplateElement("sessionFormTemplate"),this.sessionData),i.ok,[{text:"Create session",active:!0,btnClass:"btn-default",name:"ok"},{text:"Cancel",active:!0,btnClass:"btn-default",name:"cancel"}]).on("button.clicked",function(){n.dismiss()}).on("confirm.button.ok",function(t){e.createSession(t)})},t.prototype.editSession=function(t){var e=this;this.sessionData=this.getDataFromCard(t),n.confirm("Edit session",this.applySessionValuesToForm(this.getTemplateElement("sessionFormTemplate"),this.sessionData),i.ok,[{text:"Update session",active:!0,btnClass:"btn-default",name:"ok"},{text:"Cancel",active:!0,btnClass:"btn-default",name:"cancel"}]).on("button.clicked",function(){n.dismiss()}).on("confirm.button.ok",function(t){e.updateSession(t)})},t.prototype.mouseOver=function(t){var e=o(t);this.sessionData={room:e.data("room"),slot:e.data("slot")},this.dragActive||0!==e.children().length||this.gridNewSessionButton.appendTo(e)},t.prototype.mouseOut=function(t,e){var s=e.toElement||e.relatedTarget;null!==s&&s!==t&&s.parentNode!==t&&s.parentNode.parentNode!==t&&s.parentNode.parentNode.parentNode!==t&&s.parentNode.parentNode.parentNode.parentNode!==t&&this.gridNewSessionButton.appendTo(this.gridButtonGroup)},t.prototype.initializeDragAndDrop=function(){var n=this,e=s.onDragStart,o=s.onDrop;s.onDragStart=function(t){n.dragActive=!0,e(t)},s.onDrop=function(t,e,s){n.movedSession(t,e),o(t,e,s),n.dragActive=!1}},t.prototype.initialize=function(){var e=this;this.uiBlock=o("#t3js-ui-block"),this.stash=o("#stash"),this.gridButtonGroup=o("#gridButtonGroup"),this.gridNewSessionButton=this.gridButtonGroup.find("#actions-document-new-in-grid"),o(document).on("click","#actions-document-new",function(){e.createNewSessionForm()}).on("click","#actions-document-new-in-grid",function(){e.createNewSessionFormInGrid()}).on("click",".icon-actions-edit-delete",function(){e.deleteSession(this)}).on("dblclick",".t3js-page-ce",function(){e.editSession(this)}).on("mouseover",".t3js-grid-cell",function(){e.mouseOver(this)}).on("mouseout",".t3js-grid-cell",function(t){e.mouseOut(this,t)}),this.initializeDragAndDrop()},new t});