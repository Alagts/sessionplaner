"use strict";define(["jquery","TYPO3/CMS/Sessionplaner/DragDrop","TYPO3/CMS/Backend/Modal","TYPO3/CMS/Backend/Severity"],function(a,s,t,n){var i={settings:{pageId:0,uiBlock:null,stash:null,gridButtonGroup:null,gridNewSessionButton:null,sessionData:{},ajaxActive:!1,dragActive:!1},setPageId:function(e){i.settings.pageId=e},getTemplateElement:function(e){return a(a("#"+e).html().replace(/^\s+|\s+$/g,""))},prepareData:function(e){var s={};return a.each(e,function(e,t){"attendees"!==t.name&&"type"!==t.name&&"level"!==t.name&&"day"!==t.name&&"room"!==t.name&&"slot"!==t.name&&"hidden"!==t.name||(t.value=parseInt(t.value)||0),s[t.name]=t.value}),s},applySessionValuesToForm:function(n,e){return a.each(e,function(e,t){var s=a("#session-form-"+e+":first",n);0<s.length&&s.val(t)}),n},applySessionValuesToCard:function(s,e){return a.each(e,function(e,t){s.find('.property[data-name="'+e+'"]').data("value",t).text(t)}),e.hidden?s.addClass("t3-page-ce-hidden"):s.removeClass("t3-page-ce-hidden"),s},addValuesFromParent:function(e,t){return"stash"===t.attr("id")?(e.day=0,e.slot=0,e.room=0):(e.day=t.data("day"),e.slot=t.data("slot"),e.room=t.data("room")),e},createSessionCard:function(e){var t=i.getTemplateElement("sessionCardTemplate");return i.applySessionValuesToCard(t,e)},updateSessionCard:function(e){var t=a('.uid[data-value="'+e.uid+'"]',".t3js-page-ce").parents(".t3js-page-ce");i.applySessionValuesToCard(t,e)},getDataFromCard:function(e){var t={};return e.find(".t3-page-ce-body-inner .property").each(function(){var e=a(this);t[e.data("name")]=e.data("value")}),t},createSessionSuccess:function(e){i.settings.sessionData.uid=e.data.uid;var t=i.createSessionCard(i.settings.sessionData);i.settings.sessionData.room&&i.settings.sessionData.slot?a('[data-room="'+i.settings.sessionData.room+'"][data-slot="'+i.settings.sessionData.slot+'"]').prepend(t):i.settings.stash.prepend(t),s.initializeDraggable(t)},updateSessionSuccess:function(){i.updateSessionCard(i.settings.sessionData)},movedSessionSuccess:function(){},deleteSessionSuccess:function(){a('[data-name="uid"]').each(function(){var e=a(this);parseInt(e.data("value"))===i.settings.sessionData.uid&&e.parents(".t3-page-ce").remove()})},beforeSend:function(){var e=!0;return i.settings.ajaxActive?e=!1:(i.settings.ajaxActive=!0,i.settings.uiBlock.removeClass("hidden")),e},afterSend:function(){i.settings.uiBlock.addClass("hidden"),i.settings.ajaxActive=!1},sendAjaxRequest:function(e,t,s){a.ajax(TYPO3.settings.ajaxUrls[e],{method:"post",beforeSend:function(){i.beforeSend()},complete:function(){i.afterSend()},data:{id:i.settings.pageId,tx_sessionplaner:{session:t}}}).done(s)},createSession:function(e){var t=i.prepareData(a("form",e.target).serializeArray());i.settings.sessionData=t,i.sendAjaxRequest("evoweb_sessionplaner_create",i.settings.sessionData,function(e){"error"!==e.status?i.createSessionSuccess(e):i.createNewSessionForm(t)})},updateSession:function(e){var t=i.prepareData(a("form",e.target).serializeArray());t.uid=i.settings.sessionData.uid,i.settings.sessionData=t,i.sendAjaxRequest("evoweb_sessionplaner_update",i.settings.sessionData,function(e){"error"!==e.status?i.updateSessionSuccess(e):i.editSession(t)})},deleteSession:function(e){i.settings.sessionData={uid:a(e).parents(".t3-page-ce").find(".uid").data("value")},i.sendAjaxRequest("evoweb_sessionplaner_delete",i.settings.sessionData,function(e){i.deleteSessionSuccess(e)})},movedSession:function(e,t){var s=i.getDataFromCard(e);i.settings.sessionData=i.addValuesFromParent(s,t),i.sendAjaxRequest("evoweb_sessionplaner_update",i.settings.sessionData,function(e){i.movedSessionSuccess(e)})},createNewSessionForm:function(e){i.settings.sessionData=e||{},t.confirm("Create session",i.applySessionValuesToForm(i.getTemplateElement("sessionFormTemplate"),i.settings.sessionData),n.ok,[{text:"Create session",active:!0,btnClass:"btn-default",name:"ok"},{text:"Cancel",active:!0,btnClass:"btn-default",name:"cancel"}]).on("button.clicked",function(){t.dismiss()}).on("confirm.button.ok",function(e){i.createSession(e)})},createNewSessionFormInGrid:function(){t.confirm("Create session",i.applySessionValuesToForm(i.getTemplateElement("sessionFormTemplate"),i.settings.sessionData),n.ok,[{text:"Create session",active:!0,btnClass:"btn-default",name:"ok"},{text:"Cancel",active:!0,btnClass:"btn-default",name:"cancel"}]).on("button.clicked",function(){t.dismiss()}).on("confirm.button.ok",function(e){i.createSession(e)})},editSession:function(e){i.settings.sessionData=e,t.confirm("Edit session",i.applySessionValuesToForm(i.getTemplateElement("sessionFormTemplate"),i.settings.sessionData),n.ok,[{text:"Update session",active:!0,btnClass:"btn-default",name:"ok"},{text:"Cancel",active:!0,btnClass:"btn-default",name:"cancel"}]).on("button.clicked",function(){t.dismiss()}).on("confirm.button.ok",function(e){i.updateSession(e)})},mouseOver:function(e){var t=a(e);i.settings.sessionData={room:t.data("room"),slot:t.data("slot")},i.settings.dragActive||0!==t.children().length||i.settings.gridNewSessionButton.appendTo(t)},mouseOut:function(e,t){var s=t.toElement||t.relatedTarget;null!==s&&s!==e&&s.parentNode!==e&&s.parentNode.parentNode!==e&&s.parentNode.parentNode.parentNode!==e&&s.parentNode.parentNode.parentNode.parentNode!==e&&i.settings.gridNewSessionButton.appendTo(i.settings.gridButtonGroup)},initializeDragAndDrop:function(){var t=s.onDragStart,n=s.onDrop;s.onDragStart=function(e){i.settings.dragActive=!0,t(e)},s.onDrop=function(e,t,s){i.movedSession(e,t),n(e,t,s),i.settings.dragActive=!1}},initialize:function(){i.settings.uiBlock=a("#t3js-ui-block"),i.settings.stash=a("#stash"),i.settings.gridButtonGroup=a("#gridButtonGroup"),i.settings.gridNewSessionButton=i.settings.gridButtonGroup.find("#actions-document-new-in-grid"),i.initializeEvents()},initializeEvents:function(){a(document).on("click","#actions-document-new",function(){i.createNewSessionForm()}).on("click","#actions-document-new-in-grid",function(){i.createNewSessionFormInGrid()}).on("click",".icon-actions-edit-delete",function(){i.deleteSession(this)}).on("dblclick",".t3js-page-ce",function(){var e=i.getDataFromCard(a(this));i.editSession(e)}).on("mouseover",".t3js-grid-cell",function(){i.mouseOver(this)}).on("mouseout",".t3js-grid-cell",function(e){i.mouseOut(this,e)}),i.initializeDragAndDrop()}};return i.initialize(),i});