define(["jquery","TYPO3/CMS/Sessionplaner/DragDrop","TYPO3/CMS/Backend/Modal"],function(a,b,c){"use strict";var d=window.TYPO3||{},e={uiBlock:null,stash:null,sessionData:{},ajaxActive:!1};return e.getUrlVars=function(){for(var a,b=[],c=window.location.href.slice(window.location.href.indexOf("?")+1).split("&"),d=0;d<c.length;d++)a=c[d].split("="),b.push(a[0]),b[a[0]]=a[1];return b},e.getUrlVar=function(a){return e.getUrlVars()[a]},e.getTemplateElement=function(b){return a(a("#"+b).html().replace(/^\s+|\s+$/g,""))},e.prepareData=function(b){var c={};return a.each(b,function(a,b){c[b.name]=b.value}),c},e.applySessionValuesToForm=function(b,c){return a.each(c,function(c,d){var e=a("dd ."+c+":first",b);e.length>0&&e.val(d)}),b},e.applySessionValuesToCard=function(b,c){var d=b.find(".t3-page-ce-body-inner");return a.each(c,function(b,c){var e=a("."+b,d);console.log(e),e.data("value",c),e.text(c)}),b},e.addValuesFromParent=function(a,b){return"stash"===b.attr("id")?(a.slot=0,a.room=0):(a.slot=b.data("slot"),a.room=b.data("room")),a},e.createSessionCard=function(a){var b=e.getTemplateElement("sessionCardTemplate");return b=e.applySessionValuesToCard(b,a)},e.updateSessionCard=function(b){var c=a('.uid[data-value="'+b.uid+'"]',".t3js-page-ce").parent();e.applySessionValuesToCard(c,b)},e.getDataFromCard=function(b){var c=a(b).find(".t3-page-ce-body-inner"),d={};return c.find(".property").each(function(){var b=a(this);d[b.data("name")]=b.data("value")}),console.log(d),d},e.createSessionSuccess=function(a){e.sessionData.uid=a.data.uid;var c=e.createSessionCard(e.sessionData);e.stash.append(c),b.initializeDraggable(c)},e.updateSessionSuccess=function(){e.updateSessionCard(e.sessionData)},e.movedSessionSuccess=function(){},e.deleteSessionSuccess=function(){var b=a(this).parents(".t3-page-ce");b.remove()},e.beforeSend=function(){var a=!0;return e.ajaxActive?a=!1:(e.ajaxActive=!0,e.uiBlock.removeClass("hidden")),a},e.afterSend=function(){e.uiBlock.addClass("hidden"),e.ajaxActive=!1},e.createSession=function(b){var c=e.prepareData(a("form",b.target).serializeArray());e.sessionData=c,a.ajax({type:"POST",url:d.settings.ajaxUrls.evoweb_sessionplaner_create,context:this,params:{},data:{id:e.getUrlVar("id"),tx_sessionplaner:{session:c}},beforeSend:e.beforeSend,complete:e.afterSend,success:e.createSessionSuccess})},e.updateSession=function(b){var c=e.prepareData(a("form",b.target).serializeArray());c.uid=e.sessionData.uid,e.sessionData=c,a.ajax({type:"POST",url:d.settings.ajaxUrls.evoweb_sessionplaner_update,context:this,params:{},data:{id:e.getUrlVar("id"),tx_sessionplaner:{session:c}},beforeSend:e.beforeSend,complete:e.afterSend,success:e.updateSessionSuccess})},e.deleteSession=function(b){b.preventDefault();var c=a(this).parents(".t3-page-ce"),f=c.find(".uid").data("value");a.ajax({type:"POST",url:d.settings.ajaxUrls.evoweb_sessionplaner_delete,context:this,params:{},data:{id:e.getUrlVar("id"),tx_sessionplaner:{session:{uid:f}}},beforeSend:e.beforeSend,complete:e.afterSend,success:e.deleteSessionSuccess})},e.movedSession=function(b,c){var f=e.getDataFromCard(b);f=e.addValuesFromParent(f,c),e.sessionData=f,a.ajax({type:"POST",url:d.settings.ajaxUrls.evoweb_sessionplaner_update,context:this,params:{},data:{id:e.getUrlVar("id"),tx_sessionplaner:{session:f}},beforeSend:e.beforeSend,complete:e.afterSend,success:e.movedSessionSuccess})},e.createNewSessionForm=function(){var a=e.getTemplateElement("sessionFormTemplate"),b=null!==opener&&"undefined"!=typeof opener.top.TYPO3?opener.top:top;c.confirm("Create session",a,b.TYPO3.Severity.ok,[{text:"Create session",active:!0,btnClass:"btn-default",name:"ok"},{text:"Cancel",active:!0,btnClass:"btn-default",name:"cancel"}]).on("button.clicked",function(){c.dismiss()}).on("confirm.button.ok",e.createSession)},e.editSessionForm=function(){e.sessionData=e.getDataFromCard(this);var a=e.applySessionValuesToForm(e.getTemplateElement("sessionFormTemplate"),e.sessionData),b=null!==opener&&"undefined"!=typeof opener.top.TYPO3?opener.top:top;c.confirm("Edit session",a,b.TYPO3.Severity.ok,[{text:"Update session",active:!0,btnClass:"btn-default",name:"ok"},{text:"Cancel",active:!0,btnClass:"btn-default",name:"cancel"}]).on("button.clicked",function(){c.dismiss()}).on("confirm.button.ok",e.updateSession)},e.initializeDragAndDrop=function(){var a=b.onDrop;b.onDrop=function(b,c,d){e.movedSession(b,c),a(b,c,d)}},e.initialize=function(){e.uiBlock=a("#t3js-ui-block"),e.stash=a("#stash"),a(document).on("click","#actions-document-new",e.createNewSessionForm).on("click",".icon-actions-edit-delete",e.deleteSession).on("dblclick",".t3js-page-ce",e.editSessionForm),e.initializeDragAndDrop()},a(e.initialize),e});